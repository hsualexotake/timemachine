window.FD=window.FD||{};window.formAnalytics=window.formAnalytics||{};window.formAnalytics.AFAnalytics=window.formAnalytics.AFAnalytics||{};window.formAnalytics.AFAnalytics.ADAPTIVE_FORM="adaptiveForm";
var init=function(){var c=window.formAnalytics.AFAnalytics._bridgeData,g=[],e=this;if(null!=c){var d=c.bridge;var l=c.guideNodePath;var v=c.data;var w=c.successHandler}c=l+".analyticsconfigparser.json";null!=d?(d.visit(function(k){(k instanceof guidelib.model.Field||k instanceof guidelib.model.GuidePanel&&!(k instanceof guidelib.model.RootPanelNode))&&g.push(k.somExpression)}),v.somArray=JSON.stringify(g),c=d._getUrl(c)):c=Granite.HTTP.externalize(c);$.ajax({url:c,type:"POST",data:v,success:function(k){if(null==
k.data)return null!=w&&w.call(e),!1;k=window.analyticsConfigGlobal=k.data;null!=d&&registerListeners(jQuery,k)},error:function(k){console.log("Failed to initialize analytics clientlibs")}})},registerListeners=function(c,g){var e={},d=window.guideBridge,l="",v="",w=!1,k=!1,m=d.customContextProperty("instanceId");c="";var r=-1;r=-1;var y="",q="",x=(new Date).getTime(),t=0,f=g.guideIdentifier,B={},z=function(a){if(null!=a)return d.resolveNode(a)},C=function(a){if(null!=a)return a.substring(0,a.lastIndexOf("."))},
n=function(a){var b=B[a],h;if(null!=a)return void 0===b&&((h=z(a))&&(b=void 0!==h.nonLocalizedTitle?h.nonLocalizedTitle+"("+h.name+")":h.name),B[a]=b),b};null==m?(m=d._getUUID(),d.customContextProperty("instanceId",m)):(t=d.customContextProperty("timeSpentOnForm"),null!=d.customContextProperty("formPath")&&(c=d.customContextProperty("formPath")));c=d.getGuidePath();r=c.indexOf("/jcr:content/guideContainer");c=c.substring(0,r);r=c.lastIndexOf("/");y=c.substring(r+1);c=c.substring(0,r);q=y+"("+c+")";
if(""!==c&&""!==y){var u=function(a){a={type:a,payload:window.formAnalytics.customEventData};a.payload.timeSpentOnForm=window.guideBridge.customContextProperty("timeSpentOnForm");var b=new CustomEvent("FormEvent");b.customEventData=a;window.dispatchEvent(b)};c=d.getFocus();r=C(c);window.formAnalytics.customEventData={formName:f,formInstance:f+"."+m,formTitle:q,fieldName:null!=c?f+"."+g.somToID[c]:" ",panelTitle:n(r),fieldTitle:n(c)};window.dispatchEvent(new CustomEvent("formAnalyticsOnRender"));u("Form renditions");
(function(){var a=window.top;a.onfocus=function(){x=(new Date).getTime()};a.onblur=function(){t+=((new Date).getTime()-x)/1E3}})();d.on("submitStart",function(a,b){t+=((new Date).getTime()-x)/1E3;d.customContextProperty("timeSpentOnForm",t);window.formAnalytics.customEventData={formName:f,formInstance:f+"."+m,formTitle:q};window.dispatchEvent(new CustomEvent("formAnalyticsOnSubmit"));u("Form submissions");w=!0});d.on("saveStarted",function(){t+=((new Date).getTime()-x)/1E3;d.customContextProperty("timeSpentOnForm",
t);window.formAnalytics.customEventData={formName:f,formInstance:f+"."+m,formTitle:q,panelTitle:n(e.panelSOM)};window.dispatchEvent(new CustomEvent("formAnalyticsOnSave"));u("Drafts");k=!0});d.on("elementHelpShown",function(a,b){"longDescription"===b._property&&(l=g.somToID[b.target.somExpression],a=void 0!==b.target.nonLocalizedTitle?b.target.nonLocalizedTitle+"("+b.target.name+")":b.target.name,l!==e.field&&(e.field=l,e.fieldSOM=b.target.somExpression),window.formAnalytics.customEventData={formName:f,
formInstance:f+"."+m,fieldName:f+"."+l,formTitle:q,fieldTitle:a,panelTitle:n(e.panelSOM)},window.dispatchEvent(new CustomEvent("formAnalyticsOnHelp")),u("Help views"))});d.on("elementFocusChanged",function(a,b){var h,p;null!=b.prevText&&(h=z(b.prevText));null!=b.newText&&(p=z(b.newText));null==h||h.value===v||void 0===h.validationState||h.validationState||(l=g.somToID[b.prevText],window.formAnalytics.customEventData={formName:f,formInstance:f+"."+m,fieldName:f+"."+l,formTitle:q,fieldTitle:h.nonLocalizedTitle+
"("+h.name+")",panelTitle:n(e.panelSOM)},window.dispatchEvent(new CustomEvent("formAnalyticsOnError")),u("Validation errors"));void 0!=p&&(void 0!==p.rawValue?v=p.rawValue:void 0!==p.value&&(v=p.value))});d.on("validationComplete",function(a,b){var h,p;if(!b._property){var D=b.newText;(function E(A){setTimeout(function(){p=D[A];h=g.somToID[p.som];window.formAnalytics.customEventData={formName:f,formInstance:f+"."+m,fieldName:f+"."+h,formTitle:q,fieldTitle:n(p.som),panelTitle:n(e.panelSOM)};window.dispatchEvent(new CustomEvent("formAnalyticsOnError"));
u("Validation errors");A--&&E(A)},100)})(D.length-1)}});window.addEventListener("beforeunload",function(){t+=((new Date).getTime()-x)/1E3;d.customContextProperty("timeSpentOnForm",t);k||w||(window.formAnalytics.customEventData={formName:f,formInstance:f+"."+m,formTitle:q,fieldName:f+"."+e.field,panelTitle:n(e.panelSOM),fieldTitle:n(e.fieldSOM)},window.dispatchEvent(new CustomEvent("formAnalyticsOnAbandon")),u("Abandoned forms"))});d.on("elementFocusChanged",function(a,b){b&&(a=b.target.jsonModel["sling:resourceType"],
"fd/af/components/actions/nextitemnav"!==a&&"fd/af/components/actions/previtemnav"!==a&&"fd/af/components/actions/submit"!==a&&"fd/af/components/actions/reset"!==a&&"fd/fp/components/actions/saveGuideDraft"!==a&&(b=b.newText,l=g.somToID[b],void 0!==l&&e.field!==l&&(a=C(b),window.formAnalytics.customEventData={formName:f,formInstance:f+"."+m,fieldName:f+"."+l,formTitle:q,panelTitle:n(a),fieldTitle:n(b)},window.dispatchEvent(new CustomEvent("formAnalyticsOnFieldVisit")),u("Field visits"),e.field=l,
e.fieldSOM=b,e.panelSOM=a,e.panel=g.somToID[a]),k=!1))});d.on("elementNavigationChanged",function(a,b){b.newText&&(e.panelSOM=b.newText,e.panel=g.somToID[e.panelSOM])})}};
window.formAnalytics.AFAnalytics.registerInit=function(c){var g={bridge:"",bridgeType:"",guideNodePath:"",data:{}};if(null!=window.guideBridge){var e=window.guideBridge;g.bridgeType=window.formAnalytics.AFAnalytics.ADAPTIVE_FORM}else console.log("bridge bot initialized");c=c.substring(c.indexOf("/content"));g.bridge=e;g.guideNodePath=c;g.data={};window.formAnalytics.AFAnalytics._bridgeData=g;e.connect(init)};