import{Registry}from"./registry.0de615f8.js";import{Player}from"./player.2a19e3aa.js";import{PlayerModel}from"./player-model.0f9b222b.js";import{ZAnalytics}from"./z-analytics.8c340981.js";class LiveAudioPlayer extends HTMLElement{get TUNE_IN_PERIODIC_TIME_SECONDS(){return 1800}async connectedCallback(){await this.fetchModel(),Registry.register(this),!0===USE_ANALYTICS&&new ZAnalytics(this),Player.audio.addEventListener("timeupdate",(()=>{Player.audioPlayer===this&&this.onTimeUpdate()})),Player.audio.addEventListener("pause",(()=>{Player.audioPlayer===this&&this.sendTuneInStreamListenStatus(this.serialNumber,this.listenId,"PAUSE",Player.audio.currentTime%this.TUNE_IN_PERIODIC_TIME_SECONDS)})),Player.audio.addEventListener("ended",(()=>{Player.audioPlayer===this&&this.sendTuneInStreamListenStatus(this.serialNumber,this.listenId,"END",Player.audio.currentTime%this.TUNE_IN_PERIODIC_TIME_SECONDS)})),Player.audio.addEventListener("sourcechange",(t=>{this.activeTrack.url===t.detail.oldsrc&&this.sendTuneInStreamListenStatus(this.serialNumber,this.listenId,"STOP",Player.audio.currentTime%this.TUNE_IN_PERIODIC_TIME_SECONDS)})),window.addEventListener("beforeunload",(t=>{Player.audioPlayer===this&&this.sendTuneInStreamListenStatus(this.serialNumber,this.listenId,"STOP",Player.audio.currentTime%this.TUNE_IN_PERIODIC_TIME_SECONDS)}))}get listenId(){return this._listenId||(this._listenId=Date.now()),this._listenId}get playerId(){return this._playerId||(this._playerId=Math.floor(Math.random()*Math.floor(999999))),this._playerId}get serialNumber(){return Player.audioId}async fetchModel(){const t=new PlayerModel(this);this.tracks=t.tracks,await this.build()}async build(){if(this.attachShadow({mode:"open"}),"square"===this.template){new((await import("./square-player-template.0879efe1.js")).default)({audioPlayer:this})}else{new((await import("./hub-player-template.b3a75539.js")).default)({audioPlayer:this}).addDescriptionClickEvent(this)}}get template(){return this.dataset.template||"hub"}get partner(){return this.dataset.partner}get guide(){return this.dataset.guide}get hostname(){return this.dataset.hostname}get src(){return this.getAttribute("src")}set src(t){this.setAttribute("src",t)}get position(){return this.dataset.position?parseInt(this.dataset.position,10):null}set position(t){this.setAttribute("data-position",t)}get playlist(){return this.dataset.playlist||"default"}set playlist(t){this.dataset.playlist=t}async play(){switch(this.status){case"loading":break;case"playing":Player.pause(this);break;case"paused":Player.resume(this);break;default:try{await this.loadTuneInMediaUrl(this),Player.play(this)}catch(t){return void await this.sendTuneInStreamLoadStatus(this.serialNumber,this.listenId,!1)}await this.sendTuneInStreamLoadStatus(this.serialNumber,this.listenId,!0)}}async loadTuneInMediaUrl(t){return fetch("/audio/api/tunein/v1/media",{method:"POST",headers:{"Content-Type":"application/json"},body:`{ "guideId": "${this.guide}", "serialNumber": "${this.serialNumber}", "listenId": ${this.listenId} }`}).then((t=>t.json())).then((e=>(t.activeTrack.url=e.url,t)))}async sendTuneInStreamLoadStatus(t,e,i=!0){return fetch("/audio/api/tunein/v1/stream/load",{method:"POST",headers:{"Content-Type":"application/json"},body:`{ "success": ${i}, "guideId": "${this.guide}", "serialNumber": "${t}", "listenId": ${e} }`}).then((t=>t.json()))}async sendTuneInStreamListenStatus(t,e,i,s){return fetch("/audio/api/tunein/v1/stream/listen",{method:"POST",headers:{"Content-Type":"application/json"},body:`{ "trigger": "${i}", "guideId": "${this.guide}", "serialNumber": "${t}", "duration": ${s}, "listenId": ${e} }`}).then((t=>t.json()))}async onTimeUpdate(){const t=Math.floor(Player.audio.currentTime)%this.TUNE_IN_PERIODIC_TIME_SECONDS;0!==t||0===Math.floor(Player.audio.currentTime)||this.periodicSent?0!==t&&(this.periodicSent=!1):(this.periodicSent=!0,await this.sendTuneInStreamListenStatus(this.serialNumber,this.listenId,"PERIODIC",this.TUNE_IN_PERIODIC_TIME_SECONDS))}get periodicSent(){return this._periodicSent}set periodicSent(t){this._periodicSent=t}get status(){return this._status||null}set status(t){this._status=t,this.classList.remove("loading","playing","paused"),null!==t&&this.classList.add(t)}get tracks(){return this._tracks}set tracks(t){this._tracks=t}get activeTrackPosition(){return this._activeTrackPosition||0}set activeTrackPosition(t){t>this.tracks.length-1?this._activeTrackPosition=this.tracks.length-1:this._activeTrackPosition=t}get activeTrack(){return this.tracks[this.activeTrackPosition]}}customElements.define("live-audio-player-wc",LiveAudioPlayer);